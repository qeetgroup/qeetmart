import { existsSync, mkdirSync, readFileSync, statSync, writeFileSync } from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const repoRoot = path.resolve(__dirname, "../../..");
const services = ["api-gateway", "auth-service", "user-service", "product-service", "inventory-service"];
const targetDir = path.join(repoRoot, "apps", "docs", "content", "v1", "services", "readmes");

mkdirSync(targetDir, { recursive: true });

const titleFromService = (service) => {
  return service
    .split("-")
    .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
    .join(" ");
};

for (const service of services) {
  const readmePath = path.join(repoRoot, "micros", service, "README.md");
  const outputPath = path.join(targetDir, `${service}.mdx`);
  let lastUpdated = "N/A";

  let body = "";
  if (existsSync(readmePath)) {
    body = readFileSync(readmePath, "utf8").trim();
    lastUpdated = statSync(readmePath).mtime.toISOString().slice(0, 10);
  } else {
    body = `No \`README.md\` was found for \`micros/${service}\` during docs sync.\n\nAdd a README and run \`pnpm --filter docs sync:readmes\`.`;
  }

  const title = `${titleFromService(service)} README (Synced)`;
  const output = `---\ntitle: ${title}\ndescription: Synced from micros/${service}/README.md.\nsection: Services\nlastUpdated: ${lastUpdated}\n---\n\n<Callout title=\"Generated content\" tone=\"info\">\n  This page is generated by \`pnpm --filter docs sync:readmes\`.\n</Callout>\n\n${body}\n`;

  writeFileSync(outputPath, output);
}

console.log(`Synced service READMEs for ${services.length} service(s).`);
