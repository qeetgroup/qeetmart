services:
  gateway:
    build:
      context: .
      dockerfile: micros/api-gateway/Dockerfile
    environment:
      PORT: "4000"
      HOST: "0.0.0.0"
      TRUST_PROXY: "true"
      CORS_ORIGINS: "http://localhost:3000,http://localhost:5173"
      CORS_CREDENTIALS: "true"
      REQUIRE_AUTH: "true"
      JWT_SECRET: "CHANGE_ME_TO_A_STRONG_SECRET"
      JWT_ISSUER: "http://auth-service:8081"
      AUTH_SERVICE_URL: "http://auth-service:8081"
      USER_SERVICE_URL: "http://user-service:8082"
      PRODUCT_SERVICE_URL: "http://product-service:8083"
      INVENTORY_SERVICE_URL: "http://inventory-service:8080"
    depends_on:
      auth-service:
        condition: service_started
      user-service:
        condition: service_started
      product-service:
        condition: service_started
      inventory-service:
        condition: service_started
    ports:
      - "4000:4000"
    restart: unless-stopped

  auth-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: auth_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d auth_db"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - auth_db_data:/var/lib/postgresql/data

  auth-service:
    build:
      context: micros/auth-service
      dockerfile: Dockerfile
    environment:
      SERVER_PORT: "8081"
      DB_HOST: auth-db
      DB_PORT: "5432"
      DB_NAME: auth_db
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      JPA_DDL_AUTO: update
      JWT_SECRET: CHANGE_ME_TO_A_STRONG_SECRET
      JWT_ISSUER_URI: http://auth-service:8081
    depends_on:
      auth-db:
        condition: service_healthy
    ports:
      - "8081:8081"
    restart: unless-stopped

  user-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d user_db"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - user_db_data:/var/lib/postgresql/data

  user-service:
    build:
      context: micros/user-service
      dockerfile: Dockerfile
    environment:
      SERVER_PORT: "8082"
      DB_HOST: user-db
      DB_PORT: "5432"
      DB_NAME: user_db
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      JPA_DDL_AUTO: update
      JWT_SECRET: CHANGE_ME_TO_A_STRONG_SECRET
      JWT_ISSUER_URI: http://auth-service:8081
    depends_on:
      user-db:
        condition: service_healthy
    ports:
      - "8082:8082"
    restart: unless-stopped

  product-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d product_db"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - product_db_data:/var/lib/postgresql/data

  product-service:
    build:
      context: micros/product-service
      dockerfile: Dockerfile
    environment:
      SERVER_PORT: "8083"
      DB_HOST: product-db
      DB_PORT: "5432"
      DB_NAME: product_db
      DB_USERNAME: postgres
      DB_PASSWORD: postgres
      JPA_DDL_AUTO: update
      JWT_SECRET: CHANGE_ME_TO_A_STRONG_SECRET
      JWT_ISSUER_URI: http://auth-service:8081
    depends_on:
      product-db:
        condition: service_healthy
    ports:
      - "8083:8083"
    restart: unless-stopped

  inventory-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: inventory
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d inventory"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - inventory_db_data:/var/lib/postgresql/data
      - ./micros/inventory-service/migrations/001_init.sql:/docker-entrypoint-initdb.d/001_init.sql:ro

  inventory-redis:
    image: redis:7.2-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  inventory-service:
    build:
      context: micros/inventory-service
      dockerfile: Dockerfile
    environment:
      PORT: "8080"
      GIN_MODE: "release"
      DATABASE_URL: "postgres://postgres:postgres@inventory-db:5432/inventory?sslmode=disable"
      REDIS_ADDR: "inventory-redis:6379"
      REDIS_PASSWORD: ""
      REDIS_DB: "0"
      RESERVATION_TTL: "10m"
      EXPIRATION_POLL_INTERVAL: "30s"
    depends_on:
      inventory-db:
        condition: service_healthy
      inventory-redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    restart: unless-stopped

volumes:
  auth_db_data:
  user_db_data:
  product_db_data:
  inventory_db_data:
