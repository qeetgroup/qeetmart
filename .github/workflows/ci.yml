name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      node: ${{ steps.filter.outputs.node }}
      java: ${{ steps.filter.outputs.java }}
      go: ${{ steps.filter.outputs.go }}
      contracts: ${{ steps.filter.outputs.contracts }}
      platform: ${{ steps.filter.outputs.platform }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            node:
              - 'apps/**'
              - 'packages/**'
              - 'micros/api-gateway/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'pnpm-workspace.yaml'
              - 'tsconfig*.json'
            java:
              - 'micros/auth-service/**'
              - 'micros/user-service/**'
              - 'micros/product-service/**'
            go:
              - 'micros/inventory-service/**'
            contracts:
              - 'contracts/openapi/**'
              - 'tools/ci/openapi-*.mjs'
              - '.github/workflows/ci.yml'
            platform:
              - 'platform/**'
              - 'helm/**'
              - '.github/workflows/ci.yml'
            docs:
              - 'apps/docs/**'
              - 'contracts/openapi/**'
              - 'micros/**/README.md'
              - 'micros/**/.env.example'
              - 'docker-compose.dev.yml'
              - '.github/workflows/ci.yml'

  node-build:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.node == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @qeetmart/shared build
      - run: pnpm --filter @qeetmart/api-gateway build
      - run: pnpm --filter @qeetmart/api-gateway test
      - run: pnpm --filter web build
      - run: pnpm --filter admin build
      - run: pnpm --filter admin bundle:check

  java-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.java == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: [auth-service, user-service, product-service]
    defaults:
      run:
        working-directory: micros/${{ matrix.service }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
      - run: ./mvnw -B test

  go-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.go == 'true'
    defaults:
      run:
        working-directory: micros/inventory-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: micros/inventory-service/go.sum
      - run: go test ./...

  contract-check:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.contracts == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: node tools/ci/openapi-lint.mjs
      - run: node tools/ci/openapi-breaking.mjs

  docs-check:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm docs:drift:check
      - run: pnpm docs:validate
      - run: pnpm --filter docs build

  platform-validate:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.platform == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
      - uses: imranismail/setup-kustomize@v2
      - run: helm lint helm/qeetmart
      - run: kustomize build platform/k8s/overlays/dev > /tmp/kustomize-dev.yaml
      - run: kustomize build platform/k8s/overlays/staging > /tmp/kustomize-staging.yaml
      - run: kustomize build platform/k8s/overlays/prod > /tmp/kustomize-prod.yaml
